### 이벤트 루프란?

자바스크립트의 특징 중 하나는 싱글 스레드로 동작한다는 것이다.

싱글 스레드 방식은 한 번에 하나의 태스크만 처리할 수 있다는 것을 의미한다.

하지만 브라우저가 동작하는 것을 살펴보면 많은 태스크가 동시에 처리되는 것처럼 느껴진다.

`HTML` 요소가 애니메이션 효과를 통해 움직이면서 이벤트를 처리하고 `HTTP` 요청을 통해 서버로부터 데이터를 가지고 오면서 렌더링을 하기도 한다.

**이처럼 자바스크립트의 동시성을 지원하는 것이 이벤트 루프이다.**

### 콜 스택(call stack)이란?

소스코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택이
바로 콜 스택이다.

함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 순차적으로 실행된다.

자바스크립트 엔진은 단 하나의 콜 스택을 사용하기 때문에 최상위 실행 컨텍스트가 종료되어 콜 스택에서

제거되기 전까지는 다른 어떤 태스크도 실행되지 않는다.

### 태스크 큐란?

`setTimeout` `setInterval` 과 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는
영역이다.

다음실행 결과를 예측해보자.

```jsx
const muji = () => {
  console.log("무지");
};

console.log("시작");
setTimeout(muji, 4000);
console.log("끝");
```

시작과 끝이 출력된 후 4초 후에 무지가 출력된다.

그렇다면 다음 결과를 예측해보자.

```jsx
const muji = () => {
  console.log("무지");
};

const makji = () => {
  console.log("막지");
};

setTimeout(muji, 0);
makji();
```

무지 막지 순서로 출력될 것이라 예상하겠지만 막지 무지 순으로 출력된다.

타이머 함수를 정리했던 것을 떠올려 보면 `setTimeout` 의 `delay` 값이 `4ms` 이하인 경우 최소 지연 시간

`4ms` 가 지정되기 때문에 막지 무지 순으로 출력된다.

1. 전역 코드가 평가되어 전역 실행 컨텍스트가 생성되고 콜 스택에 푸시된다.
2. 전역 코드가 실행되기 시작하여 `setTimeout` 함수가 호출된다. 이 때 `setTimeout` 함수의 함수 실행
   컨텍스트가 생성되고 콜 스택에 푸시되며 현재 실행중인 컨텍스트가 된다.
   브라우저의 `Web API` 인 타이머 함수도 함수이므로 함수 실행컨텍스트를 생성한다.
3. `setTimeout` 함수가 실행되면 `setTimeout`의 콜백함수를 호출 스케줄링하고 종료되어 콜 스택에서
   팝된다.
4. 브라우저가 수행하는 `4-1` 와 자바스크립트 엔진이 수행하는 `4-2` 가 병렬 처리 된다.
   1. 브라우저는 타이머를 설정하고 타이머의 만료를 기다린다. 이후 타이머가 완료되면 콜백 함수
      `muji` 가 태스트 큐에 푸시된다.
   2. `makji` 함수가 호출되어 `makji` 함수의 함수 실행 컨텍스트가 생성되고 콜 스택에 푸시되며
      현재 실행중인 컨텍스트가 된다.
      `makji` 함수가 완료되면 콜 스택에서 팝된다.
5. 전역 코드 실행이 종료되고 전역 실행 컨텍스트가 콜 스택에서 팝된다. 이로서 콜 스택에는 아무런
   실행 컨텍스트가 존재하지 않게 된다.
6. 이벤트 루프에 의해 콜 스택이 비어있음이 감지되고 태스크 큐에서 대기 중인 콜백함수 `muji` 가
   이벤트 루프에 의해 콜 스택에 푸시된다.
   콜백 함수 `muji` 의 함수 실행 컨텍스트가 생성되고 콜 스택에 푸시되며 현재 실행중인 컨텍스트가 된다.
   `muji` 함수가 완료되면 콜 스택에서 팝된다.

- 비동기 함수인 `setTimeout` 의 콜백 함수는 태스크 큐에 푸시되어 대기하다가 **콜 스택이 비게 되면,
  즉 전역 코드 및 명시적으로 호출된 함수가 모두 종료하면 비로소 콜 스택에 푸시되어 실행된다.**
- **자바스크립트는 싱글 스레드 방식으로 동작한다.**
- **싱글 스레드로 동작하는 것은 브라우저가 아닌 브라우저에 내장된 자바스크립트 엔진이다.**
- 만약 모든 자바스크립트 코드가 자바 스크립트 엔진에서 싱글 스레드 방식으로 동작한다면 자바스크립트는
  비동기로 동작할 수 없다.
- **자바스크립트 엔진은 싱글스레드로 동작하지만 브라우저는 멀티 스레드로 동작한다.**
